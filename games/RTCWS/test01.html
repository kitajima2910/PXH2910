<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
</head>

<body>
    <div style="display: flex">
        <div style="margin-right: 100px;">
            <textarea name="txtContent" id="txtContent" cols="30" rows="10"></textarea>
            <button id="send">Send Data</button>
        </div>
        <div>
            <pre id="txtData">Nội dung nhận</pre>
        </div>
    </div>

    <br />
    <br />
    <br />
    <div style="display: flex">
        <div style="margin-right: 100px">
            <p>Connection String Local:</p>
            <textarea name="txtCreate" id="txtCreate" cols="30" rows="3" disabled></textarea>
        </div>
        <div>
            <p>Accept Connection:</p>
            <textarea name="txtAccept" id="txtAccept" cols="30" rows="3" disabled></textarea>
        </div>
    </div>
    <span id="txtStatus">Trạng thái: Waiting</span>
</body>
<script>
    // Khai báo các biến
    const txtContent = document.getElementById("txtContent");
    const txtAccept = document.getElementById("txtAccept");
    const txtCreate = document.getElementById("txtCreate");

    // WebSocket
    const socket = new WebSocket('wss://18.142.128.26:6969'); // Thay đổi URL nếu cần

    // Xử lý khi kết nối được mở
    socket.addEventListener('open', (event) => {
        console.log('WebSocket connection opened');
        socket.send("Local connected");
    });

    // Xử lý khi nhận được dữ liệu từ máy chủ
    socket.addEventListener('message', (event) => {
        try {

            const message = event.data;
            if (JSON.parse(message).type === "answer") {

                // console.log(`Received message from server: ${message}`);

                // Reset txtAccept trước khi thêm
                txtAccept.value = "";
                txtAccept.value = message;
            }

        } catch (error) {

        }
    });

    // WebRTC
    const local = new RTCPeerConnection();
    local.onicecandidate = function (e) {
        const connStr = JSON.stringify(local.localDescription);
        console.log("PXH onicecandidate: ", connStr);
        txtCreate.value = connStr;
    };

    const dataChannel = local.createDataChannel("channel");
    dataChannel.onmessage = function (e) {
        console.log("MSG Remote: " + e.data);
        document.getElementById("txtData").textContent = e.data;
    };
    dataChannel.onopen = function (e) {
        console.log("Open");
        document.getElementById("txtStatus").textContent = "Trạng thái: Open";
    };
    dataChannel.onclose = function (e) {
        console.log("Close");
        document.getElementById("txtStatus").textContent = "Trạng thái: Close";
    };

    local.createOffer().then(function (o) {
        console.log(local.setLocalDescription(o));
        return local.setLocalDescription(o);
    });

    // Truyền data vào
    // document.getElementById("txtAccept").addEventListener("change", (e) => {
    //   if (txtAccept.value !== "") {
    //     console.log("Có data");
    //     local
    //       .setRemoteDescription(JSON.parse(txtAccept.value))
    //       .then(function () {
    //         console.log("Done");
    //       });
    //   }
    // });

    const interval = setInterval(() => {

        // WS gửi xuống server
        if (document.getElementById("txtStatus").textContent !== "Trạng thái: Open") {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(txtCreate.value);
            }
        }

        if (txtAccept.value !== "") {
            local
                .setRemoteDescription(JSON.parse(txtAccept.value))
                .then(function () {
                    // console.log("Done");
                    if (local.remoteDescription.sdp !== "") {
                        clearInterval(interval);
                    }
                });
        }

    }, 500);

    // Send msg
    document.getElementById("send").addEventListener("click", (e) => {
        if (txtContent.value === "") {
            console.log("Chưa nhập");
        } else {
            console.log(txtContent.value);
            dataChannel.send(txtContent.value);
            txtContent.value = "";
        }
    });
</script>

</html>