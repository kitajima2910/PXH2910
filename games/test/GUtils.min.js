(function(n,h){var m=function(){this.originGetItem=Storage.prototype.getItem;this.originSetItem=Storage.prototype.setItem;this.originRemoveItem=Storage.prototype.removeItem;var c=this;Storage.prototype.setItem=function(b,a){var d=window.glUtils.hasUserId()?b+"_"+window.glUtils.getUserID():b;window.glUtils.log("HookLocalStorage.setItem key="+d+", value="+a);c.originSetItem.apply(this,[d,a]);window.glUtils.hasUserId()&&window.glUtils.addToListKey(d)&&window.glUtils.saveListKey()};Storage.prototype.getItem=
function(a){a=window.glUtils.hasUserId()?a+"_"+window.glUtils.getUserID():a;window.glUtils.log("HookLocalStorage.getItem key="+a);return c.originGetItem.apply(this,[a])};Storage.prototype.removeItem=function(a){a=window.glUtils.hasUserId()?a+"_"+window.glUtils.getUserID():a;window.glUtils.log("HookLocalStorage.removeItem key="+a);c.originRemoveItem.apply(this,[a])}};m.prototype.getItem=function(a){return this.originGetItem.apply(localStorage,arguments)};m.prototype.setItem=function(a,b){this.originSetItem.apply(localStorage,
arguments)};m.prototype.removeItem=function(a){this.originRemoveItem.apply(localStorage,arguments)};var a=function(){};a.Event={};a.Event.EVENT_SAVE_TO_SERVER_SUCCESS="EVENT_SAVE_TO_SERVER_SUCCESS";a.Event.EVENT_SAVE_TO_SERVER_FAIL="EVENT_SAVE_TO_SERVER_FAIL";a.Event.EVENT_LOAD_FROM_SERVER_SUCCESS="EVENT_LOAD_FROM_SERVER_SUCCESS";a.Event.EVENT_LOAD_FROM_SERVER_FAIL="EVENT_LOAD_FROM_SERVER_FAIL";a.NetworkStatus={};a.NetworkStatus.STATUS_LOAD_FROM_SERVER_SUCCESS=0;a.NetworkStatus.STATUS_LOAD_FROM_SERVER_FAIL=
1;a.NetworkStatus.STATUS_SAVE_TO_SERVER_SUCCESS=2;a.NetworkStatus.STATUS_SAVE_TO_SERVER_FAIL=3;a.State={};a.State.STATE_NO_CONNECT=0;a.State.STATE_CONNECTING=1;a.State.STATE_CONNECT_ERROR=2;a.State.STATE_SAVE_FAIL=3;a.State.STATE_NOT_FOUND_USER=4;a.State.STATE_LOAD_DONE=5;a.State.STATE_SAVE_DONE=6;a.STATE_STR="STATE_NO_CONNECT STATE_CONNECTING STATE_CONNECT_ERROR STATE_SAVE_FAIL STATE_NOT_FOUND_USER STATE_LOAD_DONE STATE_SAVE_DONE".split(" ");a.prototype.hasUserID=!1;a.prototype.UserID="";a.prototype.listKey=
[];a.prototype.lastLocalKeyCompare=0;a.prototype.user_data="";a.prototype.databaseSaveKey="testGame";a.prototype.connState=a.State.STATE_NO_CONNECT;a.prototype.currentKeyCompare=-1;a.prototype.fptBillingText="Ch\u1ec9 v\u1edbi 20.000 VND/th\u00e1ng th\u01b0\u1edfng th\u1ee9c g\u00f3i Game kh\u00f4ng gi\u1edbi h\u1ea1n tr\u00ean FPT play";a.prototype.enableDebugLog=!1;a.prototype.log=function(a){this.enableDebugLog&&console.log("[GUtils] "+a)};var p=function(){this.callback=this.target=null};a.prototype.listenners=
{};a.prototype.addEventListenner=function(a,b,e){var d=new p;d.target=e;d.callback=b;this.listenners[a]===h&&(this.listenners[a]=[]);this.listenners[a].push(d)};a.prototype.dispatchEvent=function(a){if(this.listenners[a]!==h){var b=0;a=this.listenners[a];for(b=0;b<a.length;b++)null!=a[b].target?a[b].callback.apply(a[b].target):a[b].callback.apply()}};a.prototype.getUserID=function(){return this.UserID};a.prototype.hasUserId=function(){return this.hasUserID};a.prototype.getURLParameters=function(a){var b=
window.document.URL.toString();if(null!=b&&b!=h&&0<b.indexOf("?")){for(var b=b.split("?")[1].split("&"),e=Array(b.length),d=Array(b.length),f=0,f=0;f<b.length;f++){var g=b[f].split("=");e[f]=g[0];d[f]=""!=g[1]?unescape(g[1]):""}for(f=0;f<b.length;f++)if(e[f]==a)return d[f]}return""};a.prototype.getServerTime=function(){var a=window.location.protocol+"//play.ludigames.com/js/games_lib/OEMHD/time.php",b;b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var e=Math.floor((new Date).getTime()/
1E3),d=0;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status)try{d=parseInt(b.responseText)}catch(a){d=e}};try{b.open("GET",a,!1)}catch(f){d=e}b.send();return d};a.prototype.getFptBillingTextFromServer=function(){var a=window.location.protocol+"//play.ludigames.com/js/games_lib/fpt/text.php",b;b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var e="",d=this;b.onreadystatechange=function(){if(4==b.readyState&&200==b.status)try{e=JSON.parse(b.responseText)[0].text,
d.log("getFptBillingText = "+e),null!=e&&""!=e&&(fptBillingText=e)}catch(a){}};try{b.open("GET",a,!0)}catch(f){}b.send()};a.prototype.getFptUserID=function(){var a=this.getURLParameters("UserID");return a=a.replace("/","")};a.prototype.saveToServerInternal=function(c,b,e,d){var f;this.user_data=b+"|"+e+"|"+d;f=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var g=this;f.onreadystatechange=function(){if(4==f.readyState&&200==f.status){var b=f.responseText,c=b.split("|");
if(0<=c[c.length-1].indexOf("error="))return 0<=c[c.length-1].indexOf("0")?g.connState=a.State.STATE_CONNECT_ERROR:g.connState=a.State.STATE_SAVE_FAIL,!1;g.connState=a.State.STATE_SAVE_DONE;"1"!=b.toString().trim()&&(g.user_data=b);return!0}4!=f.readyState||0!=f.status&&404!=f.status||(g.connState=a.State.STATE_NO_CONNECT)};this.connState=a.State.STATE_CONNECTING;try{var k=window.location.protocol+"//play.ludigames.com/js/games_lib/OEMHD/";0<=window.location.href.indexOf("localhost:7456")||0<=window.location.href.indexOf("localhost:50000")||
0<=window.location.href.indexOf("vntools.sai.gameloft.com")?f.open("GET",k+"saveTest.php?id="+c+"&pk="+this.databaseSaveKey+"&data="+b+"&exData="+e+"&score="+d,!0):f.open("GET",k+"save.php?id="+c+"&pk="+this.databaseSaveKey+"&data="+b+"&exData="+e+"&score="+d,!0)}catch(l){this.connState=a.State.STATE_NO_CONNECT}f.send()};a.prototype.loadFromServerInternal=function(c){var b;b=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var e=this;b.onreadystatechange=function(){if(4==
b.readyState&&200==b.status){var c=b.responseText,d=c.split("|");if(0<=d[d.length-1].indexOf("error="))return 0<=d[d.length-1].indexOf("0")?e.connState=a.State.STATE_CONNECT_ERROR:e.connState=a.State.STATE_NOT_FOUND_USER,!1;e.connState=a.State.STATE_LOAD_DONE;e.user_data=c;return!0}4!=b.readyState||0!=b.status&&404!=b.status||(e.connState=a.State.STATE_NO_CONNECT)};this.connState=a.State.STATE_CONNECTING;try{var d=window.location.protocol+"//play.ludigames.com/js/games_lib/OEMHD/";0<=window.location.href.indexOf("localhost:7456")||
0<=window.location.href.indexOf("localhost:50000")||0<=window.location.href.indexOf("vntools.sai.gameloft.com")?b.open("GET",d+"loadTest.php?id="+c+"&pk="+this.databaseSaveKey,!1):b.open("GET",d+"load.php?id="+c+"&pk="+this.databaseSaveKey,!1)}catch(f){this.connState=a.State.STATE_NO_CONNECT}b.send()};a.prototype.addToListKey=function(a){return 0>this.listKey.indexOf(a)?(this.listKey.push(a),!0):!1};a.prototype.getListKey=function(){var a=window.hookLocalStorage.getItem(this.databaseSaveKey+"_"+this.UserID);
null!=a&&a!=h&&(this.listKey=JSON.parse(a));a=window.hookLocalStorage.getItem(this.databaseSaveKey+"_"+this.UserID+"_KeyCmp");null!=a&&a!=h&&(this.lastLocalKeyCompare=parseInt(a));this.log("getListKey = "+this.listKey+", keyCompare="+this.lastLocalKeyCompare)};a.prototype.saveListKey=function(){window.hookLocalStorage.setItem(this.databaseSaveKey+"_"+this.UserID,JSON.stringify(this.listKey));this.log("saveListKey = "+JSON.stringify(this.listKey))};a.prototype.getDataToSave=function(){for(var a={},
b=0;b<this.listKey.length;b++){var e=this.listKey[b],d=window.hookLocalStorage.getItem(e);if(null!=d&&5E3<d.length)this.log("getDataToSave ignore this key="+e+" because value.length too long ="+d.length),this.log("******************************************PLEASE FIX THIS SAVE IN GAME *******************************************");else try{a[e]="object"===typeof d?JSON.parse(d):d}catch(f){a[e]=d}}return JSON.stringify(a)+"keycp="+this.lastLocalKeyCompare};a.prototype.init=function(a,b){this.databaseSaveKey=
a;this.enableDebugLog=b;var e=this.getFptUserID();e!=h&&""!=e&&(this.hasUserID=!0,this.UserID=e,this.getListKey());this.getFptBillingTextFromServer();this.log("GUtils.init hasUserID = "+this.hasUserID+", UserID = "+e+", databaseSaveKey = "+this.databaseSaveKey)};a.prototype.saveToServer=function(c){this.log("SaveToServer");var b=this;this.hasUserID?(0>c?(this.lastLocalKeyCompare=this.getServerTime(),this.log("SaveToServer using server time for key Compare = "+this.lastLocalKeyCompare)):this.lastLocalKeyCompare=
c,window.hookLocalStorage.setItem(this.databaseSaveKey+"_"+this.UserID+"_KeyCmp",this.lastLocalKeyCompare),c=this.getDataToSave(),this.log("exData = "+c),this.saveToServerInternal(this.UserID,[],c,0),window.requestAnimationFrame(function d(c){b.connState==a.State.STATE_CONNECTING?window.requestAnimationFrame(d):(b.log("SaveToServer connState = "+a.STATE_STR[b.connState]),b.connState==a.State.STATE_SAVE_DONE?b.dispatchEvent(a.Event.EVENT_SAVE_TO_SERVER_SUCCESS):b.dispatchEvent(a.Event.EVENT_SAVE_TO_SERVER_FAIL))})):
this.dispatchEvent(a.Event.EVENT_SAVE_TO_SERVER_FAIL)};a.prototype.setKeyCompare=function(a){this.currentKeyCompare=a};a.prototype.saveToServerUseExistKC=function(){this.SaveToServer(currentKeyCompare)};a.prototype.loadFromServer=function(){this.log("LoadSaveFromServer");var c=this;this.hasUserID?(this.loadFromServerInternal(this.UserID),window.requestAnimationFrame(function e(d){if(c.connState!=a.State.STATE_CONNECTING)if(c.log("LoadSaveFromServer connState = "+a.STATE_STR[c.connState]),c.connState==
a.State.STATE_LOAD_DONE)try{var f=c.user_data.split("|")[1],g=parseInt(f.substr(f.indexOf("keycp=")+6)),f=f.substr(0,f.indexOf("keycp=")),k=JSON.parse(f);c.log("dataJson = "+JSON.stringify(k)+", keycp = "+g+", lastLocalKeyCompare = "+c.lastLocalKeyCompare);if(g>c.lastLocalKeyCompare){for(var l in k){var h;try{h="object"===typeof k[l]?JSON.stringify(k[l]):k[l]}catch(m){h=k[l]}c.log("save key="+l+" value="+h);window.hookLocalStorage.setItem(l,h);c.addToListKey(l)}c.saveListKey();c.lastLocalKeyCompare=
g;window.hookLocalStorage.setItem(c.databaseSaveKey+"_"+c.UserID+"_KeyCmp",c.lastLocalKeyCompare)}else g<c.lastLocalKeyCompare&&c.SaveToServer(c.lastLocalKeyCompare);c.dispatchEvent(a.Event.EVENT_LOAD_FROM_SERVER_SUCCESS)}catch(n){}else c.dispatchEvent(a.Event.EVENT_LOAD_FROM_SERVER_FAIL);else window.requestAnimationFrame(e)})):this.dispatchEvent(a.Event.EVENT_LOAD_FROM_SERVER_FAIL)};a.prototype.getFptBillingText=function(){return this.fptBillingText};a.prototype.getDatabaseSaveKey=function(){return this.databaseSaveKey};
n.hookLocalStorage=new m;n.GUtils=a;n.glUtils=new a})(window);
